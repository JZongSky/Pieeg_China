{% extends 'admin/base.html' %}

{% block title %}创建产品 - PIEEG管理后台{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">创建产品</h1>
            </div>
            <div class="col-sm-6">
                <div class="float-right">
                    <a href="{{ url_for('admin.products') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-1"></i> 返回产品列表
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <form action="{{ url_for('admin.create_product') }}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="name">产品名称 <span class="text-danger">*</span></label>
                                <input type="text" id="name" name="name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="slug">产品别名 <span class="text-danger">*</span></label>
                                <input type="text" id="slug" name="slug" class="form-control" required>
                                <small class="form-text text-muted">用于URL，只能包含字母、数字、连字符和下划线</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="short_description">简短描述</label>
                                <textarea id="short_description" name="short_description" class="form-control" rows="3"></textarea>
                                <small class="form-text text-muted">简短描述将显示在产品列表中，建议不超过100字</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">详细描述</label>
                                <textarea id="description" name="description" class="form-control summernote"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="applications">应用场景</label>
                                <textarea id="applications" name="applications" class="form-control summernote"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>产品特性</label>
                                <div id="features-container">
                                    <div class="input-group mb-2">
                                        <input type="text" name="features[]" class="form-control" placeholder="输入产品特性">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-danger remove-feature" disabled>
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-feature" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus mr-1"></i> 添加特性
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>产品规格</label>
                                <div id="specs-container">
                                    <div class="input-group mb-2">
                                        <input type="text" name="spec_names[]" class="form-control" placeholder="规格名称">
                                        <input type="text" name="spec_values[]" class="form-control" placeholder="规格值">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-danger remove-spec" disabled>
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-spec" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus mr-1"></i> 添加规格
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="category_id">产品分类</label>
                                <select id="category_id" name="category_id" class="form-control">
                                    <option value="">-- 选择分类 --</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="price">价格</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">¥</span>
                                    </div>
                                    <input type="number" id="price" name="price" class="form-control" step="0.01" min="0" value="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="purchase_url">购买链接</label>
                                <input type="url" id="purchase_url" name="purchase_url" class="form-control">
                                <small class="form-text text-muted">产品购买页面的完整URL</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="inquiry_url">咨询链接</label>
                                <input type="url" id="inquiry_url" name="inquiry_url" class="form-control">
                                <small class="form-text text-muted">产品咨询页面的完整URL，留空则使用默认邮件咨询</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="image">主图片</label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="image" name="image" accept="image/*">
                                    <label class="custom-file-label" for="image">选择文件</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>产品图库</label>
                                <div id="gallery-container">
                                    <!-- 图库图片将在这里动态添加 -->
                                </div>
                                <div class="custom-file mt-2">
                                    <input type="file" class="custom-file-input" id="gallery-image" accept="image/*">
                                    <label class="custom-file-label" for="gallery-image">添加图库图片</label>
                                </div>
                                <small class="form-text text-muted">上传后将自动添加到图库</small>
                            </div>
                            
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="is_featured" name="is_featured">
                                    <label class="custom-control-label" for="is_featured">推荐产品</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" checked>
                                    <label class="custom-control-label" for="is_active">上架产品</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> 创建产品
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-zh-CN.min.js"></script>
<script>
    $(document).ready(function() {
        // 初始化富文本编辑器
        $('.summernote').summernote({
            height: 300,
            lang: 'zh-CN',
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });
        
        // 产品名称自动生成别名
        $('#name').on('input', function() {
            if (!$('#slug').data('manually-changed')) {
                const slug = $(this).val()
                    .toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                $('#slug').val(slug);
            }
        });
        
        $('#slug').on('input', function() {
            $(this).data('manually-changed', true);
        });
        
        // 添加产品特性
        $('#add-feature').click(function() {
            const featureHtml = `
                <div class="input-group mb-2">
                    <input type="text" name="features[]" class="form-control" placeholder="输入产品特性">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-danger remove-feature">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            $('#features-container').append(featureHtml);
            
            // 启用第一个删除按钮
            if ($('#features-container .input-group').length > 1) {
                $('#features-container .remove-feature').prop('disabled', false);
            }
        });
        
        // 删除产品特性
        $(document).on('click', '.remove-feature', function() {
            $(this).closest('.input-group').remove();
            
            // 如果只剩一个输入框，禁用删除按钮
            if ($('#features-container .input-group').length === 1) {
                $('#features-container .remove-feature').prop('disabled', true);
            }
        });
        
        // 添加产品规格
        $('#add-spec').click(function() {
            const specHtml = `
                <div class="input-group mb-2">
                    <input type="text" name="spec_names[]" class="form-control" placeholder="规格名称">
                    <input type="text" name="spec_values[]" class="form-control" placeholder="规格值">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-danger remove-spec">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            $('#specs-container').append(specHtml);
            
            // 启用第一个删除按钮
            if ($('#specs-container .input-group').length > 1) {
                $('#specs-container .remove-spec').prop('disabled', false);
            }
        });
        
        // 删除产品规格
        $(document).on('click', '.remove-spec', function() {
            $(this).closest('.input-group').remove();
            
            // 如果只剩一个输入框，禁用删除按钮
            if ($('#specs-container .input-group').length === 1) {
                $('#specs-container .remove-spec').prop('disabled', true);
            }
        });
        
        // 图片预览
        $('#image').change(function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if ($('#image-preview').length) {
                        $('#image-preview').attr('src', e.target.result);
                    } else {
                        $('<div class="mt-2"><img id="image-preview" src="' + e.target.result + '" class="img-thumbnail" style="max-height: 150px;"></div>').insertAfter($(this).closest('.custom-file'));
                    }
                }
                reader.readAsDataURL(file);
                
                // 更新文件名显示
                $(this).next('.custom-file-label').html(file.name);
            }
        });
        
        // 图库图片上传
        $('#gallery-image').change(function() {
            const file = this.files[0];
            if (file) {
                // 这里应该是上传图片到服务器，然后获取URL
                // 为了演示，我们使用本地FileReader模拟
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result; // 实际应用中，这里应该是服务器返回的URL
                    
                    const galleryItemHtml = `
                        <div class="gallery-item mb-2">
                            <div class="input-group">
                                <input type="hidden" name="gallery_images[]" value="${imageUrl}">
                                <input type="text" class="form-control" value="${file.name}" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-danger remove-gallery-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-1">
                                <img src="${imageUrl}" class="img-thumbnail" style="height: 80px;">
                            </div>
                        </div>
                    `;
                    $('#gallery-container').append(galleryItemHtml);
                }
                reader.readAsDataURL(file);
                
                // 重置文件输入
                $(this).val('');
                $(this).next('.custom-file-label').html('添加图库图片');
            }
        });
        
        // 删除图库图片
        $(document).on('click', '.remove-gallery-item', function() {
            $(this).closest('.gallery-item').remove();
        });
    });
</script>
{% endblock %}
